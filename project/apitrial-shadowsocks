#!/bin/bash

# === Konfigurasi Awal ===
duration=${1:-60} # Durasi dari argumen, default 60 menit
user="trial$(openssl rand -hex 2 | head -c 4)"
uuid=$(cat /proc/sys/kernel/random/uuid)
domain=$(cat /etc/xray/domain 2>/dev/null || hostname -f)
ns_domain=$(cat /etc/xray/dns 2>/dev/null || echo "NS domain not set")
city=$(cat /etc/xray/city 2>/dev/null || echo "Unknown")
pubkey=$(cat /etc/slowdns/server.pub 2>/dev/null || echo "Not Available")
ip=$(curl -s ipv4.icanhazip.com)
exp=$(date -d "+$duration minutes" +"%Y-%m-%d %H:%M:%S")
method="aes-256-gcm"
password="$uuid"

# === Pastikan config ada
mkdir -p /etc/xray/shadowsocks
if [ ! -f "/etc/xray/shadowsocks/config.json" ]; then
    echo '{"clients":[]}' > /etc/xray/shadowsocks/config.json
fi

# === Tambahkan user ke config.json
tmpfile=$(mktemp)
jq --arg password "$password" --arg method "$method" --arg email "$user" \
   '.clients += [{"password": $password, "method": $method, "email": $email}]' \
   /etc/xray/shadowsocks/config.json > "$tmpfile" && mv "$tmpfile" /etc/xray/shadowsocks/config.json

# === Auto remove setelah expired
tmux new-session -d -s "trial_ss_$user" "sleep $((duration * 60)); \
tmpfile2=\$(mktemp); \
jq --arg email \"$user\" 'del(.clients[] | select(.email == \$email))' /etc/xray/shadowsocks/config.json > \$tmpfile2 && mv \$tmpfile2 /etc/xray/shadowsocks/config.json; \
systemctl restart shadowsocks@config"

# === Restart service
systemctl restart shadowsocks@config

# === Encode SS link
ss_base64=$(echo -n "${method}:${password}" | base64 -w 0)
ss_link_ws="ss://${ss_base64}@${domain}:443?plugin=xray-plugin;mux=0;path=/shadowsocks;host=${domain};tls;network=ws#${user}-WS"
ss_link_grpc="ss://${ss_base64}@${domain}:443?plugin=xray-plugin;mux=0;serviceName=ss-grpc;host=${domain};tls#${user}-gRPC"

# === Output JSON ke bot
jq -n \
  --arg status "success" \
  --arg protocol "shadowsocks" \
  --arg username "$user" \
  --arg uuid "$uuid" \
  --arg password "$password" \
  --arg ip "$ip" \
  --arg domain "$domain" \
  --arg ns_domain "$ns_domain" \
  --arg city "$city" \
  --arg public_key "$pubkey" \
  --arg expiration "$exp" \
  --arg method "$method" \
  --arg link_ws "$ss_link_ws" \
  --arg link_grpc "$ss_link_grpc" \
  '{
    status: $status,
    protocol: $protocol,
    username: $username,
    uuid: $uuid,
    password: $password,
    ip: $ip,
    domain: $domain,
    ns_domain: $ns_domain,
    city: $city,
    public_key: $public_key,
    expiration: $expiration,
    method: $method,
    link_ws: $link_ws,
    link_grpc: $link_grpc,
    port_tls: "443",
    path: "/shadowsocks",
    service_name: "ss-grpc"
  }'