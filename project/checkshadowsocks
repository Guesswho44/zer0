#!/bin/bash

# Valid Script
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")
data_ip="https://raw.githubusercontent.com/Guesswho44/izinsc/main/izin"
checking_sc() {
  useexp=$(wget -qO- $data_ip | grep $ipsaya | awk '{print $3}')
  if [[ $date_list < $useexp ]]; then
    echo -ne
  else
    echo -e "\033[1;93m────────────────────────────────────────────\033[0m"
    echo -e "\033[42m          404 NOT FOUND AUTOSCRIPT          \033[0m"
    echo -e "\033[1;93m────────────────────────────────────────────\033[0m"
    echo -e ""
    echo -e "            ${RED}PERMISSION DENIED !${NC}"
    echo -e "   \033[0;33mYour VPS${NC} $ipsaya \033[0;33mHas been Banned${NC}"
    echo -e "     \033[0;33mBuy access permissions for scripts${NC}"
    echo -e "             \033[0;33mContact Admin :${NC}"
    echo -e "      ${GREEN}WhatsApp${NC} wa.me/6283877140463"
    echo -e "\033[1;93m────────────────────────────────────────────\033[0m"
    sleep 5
    reboot
  fi
}
checking_sc

# ============================================
# CONFIG & COLORS
# ============================================
green="\e[38;5;82m"
        red="\e[38;5;196m"
        neutral="\e[0m"
        orange="\e[38;5;130m"
        blue="\e[38;5;39m"
        yellow="\e[38;5;226m"
        purple="\e[38;5;141m"
        bold_white="\e[1;37m"
        reset="\e[0m"
        pink="\e[38;5;205m"

rand_color() {
    colors=(16 22 28 34 40 46 52 58 64 70 76 82 88 94 100 106 112 118 124 130 136 142 148 154 160 166 172 178 184 190 196 202 208 214 220 226 232 238 244 250)
    echo "${colors[$RANDOM % ${#colors[@]}]}"
}
header_color="\e[38;5;$(rand_color)m"
line_color="\e[38;5;$(rand_color)m"

# ============================================
# ISP CACHE
# ============================================
declare -A ISP_CACHE
get_isp() {
    local ip="$1"
    [[ -z "$ip" ]] && echo "-" && return

    # Cek cache dulu
    if [[ -n "${ISP_CACHE[$ip]}" ]]; then
        echo "${ISP_CACHE[$ip]}"
        return
    fi

    # Ambil ASN/ISP dari whois
    local asn
    asn=$(whois "$ip" 2>/dev/null | grep -i "descr" | awk -F: '{print $2}' | grep -v '^$' | head -n 1 | xargs)

    # Jika gagal ambil dari whois, fallback ke ipinfo.io
    if [[ -z "$asn" ]]; then
        asn=$(curl -s "ipinfo.io/$ip/org" | cut -d' ' -f2-)
    fi

    # Jika masih kosong, beri tanda "-"
    [[ -z "$asn" ]] && asn="-"

    # Simpan ke cache dan return
    ISP_CACHE[$ip]="$asn"
    echo "$asn"
}

# ============================================
# CONVERT SIZE
# ============================================
convert_size() {
    local bytes="${1:-0}"
    [[ -z "$bytes" ]] && bytes=0
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(((bytes + 1023)/1024))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(((bytes + 1048575)/1048576))MB"
    else
        echo "$(((bytes + 1073741823)/1073741824))GB"
    fi
}

# ============================================
# HYBRID LOGIN COUNT FIX
# ============================================
get_login_count_hybrid() {
    local user="$1"
    local log_file="$2"
    local seconds="${3:-15}"

    mapfile -t log_lines < <(awk -v u="$user" -v s="$seconds" '
        {
            split($1,d,"/"); split($2,t,":")
            log_epoch = mktime(d[1]" "d[2]" "d[3]" "t[1]" "t[2]" "t[3])
            now_epoch = systime()
            if ($0 ~ u && log_epoch >= (now_epoch - s) && $0 !~ "127.0.0.1") print $0
        }
    ' "$log_file")

    declare -A user_ips
    local ip
    for line in "${log_lines[@]}"; do
        ip=$(echo "$line" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -n1)
        [[ -n "$ip" ]] && user_ips["$ip"]=1
    done

    for ip in "${!user_ips[@]}"; do
        echo "$ip"
    done | sort -u
}

# ============================================
# CHECK SHADOWSOCKS USERS
# ============================================
check_shadowsocks() {
    local LOG_FILE="/var/log/xray/access.log"
    local USER_LIST=($(grep '^###' /etc/xray/shadowsocks/.shadowsocks.db | awk '{print $2}' | sort -u))

    echo -ne "${green}Checking Shadowsocks Accounts "  
    for i in {1..2}; do  
        for j in ⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏; do  
            echo -ne "\r${green}Checking Shadowsocks Accounts $j\e[0m"  
            sleep 0.1  
        done  
    done  
    echo -e "\r${green}Shadowsocks Account Check Completed!    ${neutral}"  
    sleep 1
    clear

    echo -e "${orange}─────────────────────────────────────────${neutral}"  
    echo -e "${green}      SHADOWSOCKS USER LOGIN ACCOUNTS     ${neutral}"  
    echo -e "${orange}─────────────────────────────────────────${neutral}"  
    printf "${green} %-12s | %-6s | %-6s | %-7s | %-s\n" \
           "Username" "Usage" "Quota" "Log/Lim" "ISP"
    echo -e "${orange}─────────────────────────────────────────${neutral}"

    for user in "${USER_LIST[@]}"; do
        active_ips=$(get_login_count_hybrid "$user" "$LOG_FILE" 15)
        [[ -z "$active_ips" ]] && continue

        login_count=$(echo "$active_ips" | wc -l)

        usage=$(cat /etc/xray/shadowsocks/usage/"$user" 2>/dev/null || echo 0)
        quota=$(cat /etc/xray/shadowsocks/"$user" 2>/dev/null || echo 0)
        ip_limit=$(cat /etc/xray/shadowsocks/"$user"IP 2>/dev/null || echo 0)

        readable_usage=$(convert_size "$usage")
        readable_quota=$(convert_size "$quota")

        provider_list=$(for ip in $active_ips; do get_isp "$ip"; done | sort -u | paste -sd',' -)

        row_color="\e[38;5;$(rand_color)m"
        printf "${green} %-12s | %-6s | %-6s | %-7s | %-s${neutral}\n" \
               "$user" "$readable_usage" "$readable_quota" "$login_count/$ip_limit" "$provider_list"
    done

    echo -e "${orange}─────────────────────────────────────────${neutral}"
}

# ============================================
# MAIN
# ============================================
check_shadowsocks
read -n 1 -s -r -p "Press [Enter] to back on menu..."